(()=>{var N;(v=>{function r(y,t=100){return o(()=>document.querySelector(y),t)}v.waitForElement=r;function l(y,t){let a=0;return function(){let m=this,i=arguments;a&&clearTimeout(a),a=setTimeout(y.bind(m,i),t)}}v.debounce=l;function s(y){let t=typeof y=="string"?new TextEncoder().encode(y):new Uint8Array(y);if(t.length>0){let a=[];for(let n=0;n<t.length;n++)a.push("%"),a.push(t[n].toString(16).padStart(2,"0"));return a.join("")}else return""}v.escapeData=s;function o(y,t=100){return new Promise(a=>{let n=setInterval(()=>{let m=y();m&&(clearInterval(n),a(m))},t)})}v.waitForFunction=o;function c(y){return new Promise(t=>setTimeout(t,y))}v.delay=c;function g(y,t,...a){let n=document.createElement(y);if(t.class){for(let m of t.class)n.classList.add(m);t.class=void 0}if(t.style){for(let m in t.style)n.style[m]=t.style[m];t.style=void 0}for(let m in t)t[m]&&(n[m]=t[m]);for(let m of a)m&&n.appendChild(m);return n}v.dom=g})(N||={});function ee(){return"React"in window&&"createElement"in React&&"Fragment"in React?(window.h=React.createElement,window.f=React.Fragment,!0):"h"in window&&"f"in window}N.waitForFunction(ee,100);var b=(r,l)=>(l?(l.headers=l.headers??{},l.ignoreApiKey||(l.headers.BETTERNCM_API_KEY=BETTERNCM_API_KEY)):l={headers:{BETTERNCM_API_KEY}},fetch(BETTERNCM_API_PATH+r,l)),V;(g=>{let r=256,l=[],s=256,o;for(;r--;)l[r]=(r+256).toString(16).substring(1);function c(v){let y=0,t=v||11;if(!o||r+t>s*2)for(o="",r=0;y<s;y++)o+=l[Math.random()*256|0];return o.substring(r,r+++t)}g.uid=c})(V||={});function T(r,...l){return APP_CONF.isOSX?(window.betterncmBridgeCallbacks??=new Map,new Promise((s,o)=>{let c=V.uid(32);betterncmBridgeCallbacks.set(c,g=>{if(betterncmBridgeCallbacks.delete(c),console.log(g),g)if(g.error)o(g.error);else if(g.result.length>0)try{s(JSON.parse(g.result))}catch(v){o(v)}else s(void 0);else o(new TypeError("\u63A5\u6536\u5230\u4E86\u4E0D\u6B63\u786E\u7684\u56DE\u8C03\u4FE1\u606F"))}),webkit?.messageHandlers?.BetterNCM?.postMessage({type:r,arguments:l,returnId:c})})):Promise.reject(new TypeError("\u4E0D\u53EF\u5728\u975E WebKit \u73AF\u5883\u4E0B\u53D1\u9001\u4FE1\u606F\u7ED9\u539F\u751F\u7AEF"))}var P=encodeURIComponent,S;(m=>{async function r(i){return await(await b(`/fs/read_dir?path=${P(i)}`)).json()}m.readDir=r;async function l(i){return await(await b(`/fs/read_file_text?path=${P(i)}`)).text()}m.readFileText=l;async function s(i){return await(await b(`/fs/read_file?path=${P(i)}`)).blob()}m.readFile=s;async function o(i){return await(await b(`/fs/mount_dir?path=${P(i)}`)).text()}m.mountDir=o;async function c(i){return await(await b(`/fs/mount_file?path=${P(i)}`)).text()}m.mountFile=c;async function g(i,x=`${i}_extracted/`){let d=await b(`/fs/unzip_file?path=${P(i)}&dest=${P(x)}`);return parseInt(await d.text())===0}m.unzip=g;async function v(i,x){return APP_CONF.isOSX?await y(i,x):(await b(`/fs/write_file_text?path=${P(i)}`,{method:"POST",body:x})).status===200}m.writeFileText=v;async function y(i,x){if(APP_CONF.isOSX)if(typeof x=="string"){let d=N.escapeData(x);return await T("/fs/write_file",i,d)}else{let d=await x.arrayBuffer(),e=N.escapeData(d);return await T("/fs/write_file",i,e)}else{let d=new FormData;return d.append("file",x),(await b(`/fs/write_file?path=${P(i)}`,{method:"POST",body:d})).status===200}}m.writeFile=y;async function t(i){return(await b(`/fs/mkdir?path=${P(i)}`)).status===200}m.mkdir=t;async function a(i){return await(await b(`/fs/exists?path=${P(i)}`)).json()}m.exists=a;async function n(i){return(await b(`/fs/remove?path=${P(i)}`)).status===200}m.remove=n})(S||={});var k=encodeURIComponent,A;(e=>{async function r(u,p=!1,w=!1){return(await b(`/app/exec${p?"_ele":""}${w?"?_showWindow":""}`,{method:"POST",body:u})).status===200}e.exec=r;let l=null;async function s(){return l===null&&(l=await(await b("/app/version")).text()),l}e.getBetterNCMVersion=s;async function o(){return await(await b("/app/bg_screenshot")).blob()}e.takeBackgroundScreenshot=o;async function c(){return await(await b("/app/get_win_position",{ignoreApiKey:!0})).json()}e.getNCMWinPos=c;async function g(){return(await b("/app/reload_plugin")).status===200}e.reloadPlugins=g;async function v(){return(await(await b("/app/datapath")).text()).replace(/\//g,"\\")}e.getDataPath=v;async function y(u,p){return await(await b(`/app/read_config?key=${k(u)}&default=${k(p)}`)).text()}e.readConfig=y;async function t(u,p){return await(await b(`/app/write_config?key=${k(u)}&value=${k(p)}`)).status===200}e.writeConfig=t;async function a(){return await(await b("/app/ncmpath")).text()}e.getNCMPath=a;async function n(){return APP_CONF.isOSX?await T("/app/show_console"):(await b("/app/show_console")).status===200}e.showConsole=n;async function m(u=!0){return(await b(`/app/set_rounded_corner?enable=${u}`)).status===200}e.setRoundedCorner=m;async function i(u,p){return await(await b(`/app/open_file_dialog?filter=${k(u)}&initialDir=${k(p)}`)).text()}e.openFileDialog=i;async function x(){return await(await b("/app/is_light_theme")).json()}e.isLightTheme=x;async function d(){return await(await b("/app/get_succeeded_hijacks")).json()}e.getSucceededHijacks=d})(A||={});var $;(x=>{function r(d,e){for(let u in d){let p=!0;for(let w=0,C=e;w<C.length;w++){let Q=C[w];d[u].toString().includes(Q)||(p=!1)}if(p)return u}}x.findNativeFunction=r;function l(d){window.legacyNativeCmder._envAdapter.callAdapter("os.navigateExternal",[d],()=>{})}x.openUrl=l;function s(){return window?.APP_CONF?.packageVersion||"0000000"}x.getNCMPackageVersion=s;function o(){return window?.APP_CONF?.appver||"0.0.0.0"}x.getNCMFullVersion=o;function c(){let d=o();return d.substring(0,d.lastIndexOf("."))}x.getNCMVersion=c;function g(){let d=o();return parseInt(d.substring(d.lastIndexOf(".")+1))}x.getNCMBuild=g;let v=()=>new Promise(d=>requestAnimationFrame(d));function y(d,e=window,u=["window"],p=[],w=[]){if(e==null)return w;if(p.push(e),typeof d=="string")typeof e[d]=="function"&&w.push([e[d],e,[...u,d]]);else for(let C of Object.getOwnPropertyNames(e))typeof e[C]=="function"&&Object.hasOwn(e,C)&&(console.log(`${u.join(".")}.${C}`),d(e[C])&&w.push([e[C],e,[...u,C]]));if(u.length<10)for(let C of Object.getOwnPropertyNames(e))typeof e[C]=="object"&&Object.hasOwn(e,C)&&!p.includes(e[C])&&!(u.length===1&&p[p.length-1]===window&&C==="betterncm")&&(u.push(C),y(d,e[C],u,p,w),u.pop());return p.pop(),w}x.searchApiFunction=y;function t(d,e=window,u=["window"],p=[],w=[]){if(e==null)return[];if(p.push(e),u.length<10)for(let C of Object.keys(e))Object.hasOwnProperty.call(e,C)&&!p.includes(e[C])&&!(u.length===1&&p[p.length-1]===window&&C==="betterncm")&&(typeof e[C]=="object"?(u.push(C),y(d,e[C],u,p,w),u.pop()):d(e[C])&&w.push([e[C],e,[...u]]));return p.pop(),w}x.searchForData=t;function a(d,e=window,u=["window"],p=[]){if(e==null)return null;if(p.push(e),typeof d=="string"){if(typeof e[d]=="function")return[e[d],e,[...u]]}else for(let w of Object.keys(e))if(Object.hasOwnProperty.call(e,w)&&typeof e[w]=="function"&&d(e[w]))return[e[w],e,[...u]];if(u.length<10){for(let w of Object.keys(e))if(Object.hasOwnProperty.call(e,w)&&typeof e[w]=="object"&&!p.includes(e[w])&&!(u.length===1&&p[p.length-1]===window&&w==="betterncm")){u.push(w);let C=a(d,e[w],u,p);if(u.pop(),C)return C}}return p.pop(),null}x.findApiFunction=a;let n=null;function m(){if(n===null){let d=a("getPlaying");if(d){let[e,u]=d;n=e.bind(u)}}return n===null?null:n()}x.getPlayingSong=m;function i(){let d=m(),e={id:d.data.id,title:d.data.name,type:"normal"};return d.from.fm&&(e.type="fm"),e}x.getPlaying=i})($||={});var I;(s=>{async function r(o){console.warn("Test Failed",o),await S.writeFileText("/__TEST_FAILED__.txt",o)}s.fail=r;async function l(o){console.warn("Test Succeeded",o),await S.writeFileText("/__TEST_SUCCEEDED__.txt",o)}s.success=l})(I||={});function te(){if(!("loadingMask"in window)){document.location.reload();return}let r=loadingMask.animate([{opacity:0},{opacity:1}],{duration:300,fill:"forwards",easing:"cubic-bezier(0.42, 0, 0.58, 1)"});r.commitStyles(),r.addEventListener("finish",l=>{document.location.reload()})}var H={fs:S,app:A,ncm:$,utils:N,tests:I,reload:te,betterncmFetch:b};window.dom=N.dom;betterncm=H;var E=H;var F=r=>{let{children:l,className:s,...o}=r;return h("a",{className:`u-ibtn5 bncm-btn u-ibtnsz8 ${s||""}`,...o},l)};var D=r=>h("span",{className:"bncm-spinner",style:{width:r.size||"16px",height:r.size||"16px"}},h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null),h("div",null));var K=r=>{let[l,s]=React.useState("transparent"),o=React.useMemo(()=>_(),void 0),[c,g]=React.useState(null),[v,y]=React.useState("");React.useEffect(()=>{(async()=>{if(!c){let a=await E.app.getBetterNCMVersion();y(a);let n=E.ncm.getNCMVersion(),i=(await(await fetch("https://gitee.com/microblock/better-ncm-v2-data/raw/master/betterncm/betterncm.json")).json()).versions.filter(x=>x.supports.includes(n));if(i.length===0)s("#F004"),g({version:"",supports:[],file:"",changelog:""});else{let x=i[0];x.version!==a&&s("#0F04"),g(x)}}})()},[c]);let t=React.useCallback(async()=>{if(c&&c.version!==v){let a=await E.app.getNCMPath(),m=`${await E.app.getDataPath()}\\betterncm.dll`;await E.fs.exists("./betterncm.dll")&&await E.fs.remove("./betterncm.dll"),await E.fs.writeFile("./betterncm.dll",await(await fetch(c?.file)).blob()),a.toLowerCase().includes("system")||E.app.exec(["cmd /c @echo off","echo BetterNCM Updating...","cd /d C:/","cd C:/",`cd /d ${a[0]}:/`,`cd "${a}"`,"taskkill /f /im cloudmusic.exe>nul","taskkill /f /im cloudmusicn.exe>nul","ping 127.0.0.1>nul & del msimg32.dll",`move "${m}" .\\msimg32.dll`,"start cloudmusic.exe"].join(" & "),!0)}else c&&g(null)},[c]);return h("section",{className:"bncm-mgr-header"},h("img",{src:"https://s1.ax1x.com/2022/08/11/vGlJN8.png",alt:"",style:{height:"64px"}}),h("div",null,h("h1",null,"BetterNCM",h("span",{style:{fontSize:"smaller",opacity:"0.8",marginLeft:"1rem"}},v)),h("div",{className:"bncm-mgr-btns"},h(F,{onClick:async()=>{E.app.exec(`explorer "${(await E.app.getDataPath()).replace(/\//g,"\\")}"`,!1,!0)}},"\u6253\u5F00\u63D2\u4EF6\u6587\u4EF6\u5939"),h(F,{onClick:async()=>{await W(),await E.app.reloadPlugins(),E.reload()}},"\u91CD\u8F7D\u63D2\u4EF6"),h(F,{style:{display:"flex",alignItems:"center",background:l},onClick:t},c===null?h(f,null,h(D,null),"\u68C0\u67E5\u66F4\u65B0\u4E2D"):c.version===v?h(f,null,"\u5DF2\u662F\u6700\u65B0\u7248\u672C"):c.version.length===0?h(f,null,"\u7248\u672C\u4E0D\u517C\u5BB9"):h(f,null,"\u70B9\u51FB\u66F4\u65B0\u5230 ",c.version)))),h("div",{className:"m-tool"},h("a",{className:"itm",onClick:()=>r.onRequestOpenStartupWarnings(),style:{width:"32px",height:"32px"}},h("svg",{width:"32px",height:"32px",viewBox:"0 0 24 24"},h("path",{fill:"currentColor",d:"M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"}))),h("a",{className:"itm",onClick:()=>E.ncm.openUrl("https://github.com/MicroCBer/BetterNCM"),style:{width:"32px",height:"32px"}},h("svg",{width:"32px",height:"32px",viewBox:"0 0 24 24"},h("path",{fill:"currentColor",d:"M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"})))))};var U=()=>{let r=React.useMemo(X,[]);return h("div",{className:"v-scroll"},h("div",null,h("div",{style:{overflowY:"scroll",overflowX:"hidden"},className:"safe-mode-info"},h("h1",null,"\u73B0\u5728\u5904\u4E8E\u5B89\u5168\u6A21\u5F0F"),h("p",null,"BetterNCM \u63D2\u4EF6\u52A0\u8F7D\u5668\u53EF\u80FD\u906D\u9047\u4E86\u591A\u6B21\u63D2\u4EF6\u52A0\u8F7D\u5931\u8D25\u91CD\u8F7D\uFF0C\u5B89\u5168\u6A21\u5F0F\u5DF2\u81EA\u52A8\u542F\u7528\uFF0C\u5728\u8BE5\u6A21\u5F0F\u4E0B\u4E0D\u4F1A\u52A0\u8F7D\u4EFB\u4F55\u63D2\u4EF6\u3002"),h("p",null,"\u63D2\u4EF6\u52A0\u8F7D\u5668\u5DF2\u7ECF\u6536\u96C6\u4E86\u6BCF\u6B21\u52A0\u8F7D\u53D1\u751F\u7684\u9519\u8BEF\uFF0C\u8BF7\u786E\u8BA4\u52A0\u8F7D\u5931\u8D25\u7684\u63D2\u4EF6\uFF0C\u5E76\u5C06\u53D1\u751F\u9519\u8BEF\u7684\u63D2\u4EF6\u624B\u52A8\u79FB\u9664\u6216\u4FEE\u6B63\u3002"),h("p",null,"\u5B8C\u6210\u8C03\u6574\u540E\uFF0C\u53EF\u4EE5\u901A\u8FC7\u6309\u4E0B\u91CD\u8F7D\u63D2\u4EF6\u5173\u95ED\u5B89\u5168\u6A21\u5F0F\u5E76\u91CD\u65B0\u52A0\u8F7D\u63D2\u4EF6\u3002"),r.length===0?h("p",null,"\u6CA1\u6709\u627E\u5230\u52A0\u8F7D\u9519\u8BEF\u8BB0\u5F55\uFF0C\u6709\u53EF\u80FD\u662F\u53D7\u5230\u63D2\u4EF6\u5F71\u54CD\u6216\u63D2\u4EF6\u7BA1\u7406\u5668\u81EA\u8EAB\u51FA\u9519\u3002"):h(f,null,h("p",null,"\u52A0\u8F7D\u9519\u8BEF\u8BB0\u5F55\uFF1A"),h("code",null,h("pre",{style:{whiteSpace:"pre-wrap"}},r))))))};var z=r=>h("div",{className:"startup-warning"},h("h1",null,"\u6B22\u8FCE\u4F7F\u7528 BetterNCM\uFF01"),h("p",null,"BetterNCM \u662F\u4E00\u4E2A\u7531\u4E00\u7FA4\u70ED\u7231\u7F51\u6613\u4E91\u97F3\u4E50\u7684\u4E91\u6751\u6751\u53CB\u5F00\u53D1\u7684 PC \u7248\u7F51\u6613\u4E91\u97F3\u4E50\u6269\u5C55\u5DE5\u5177\uFF0C\u53EF\u4EE5\u63D0\u4F9B\u975E\u5E38\u4E30\u5BCC\u7684\u81EA\u5B9A\u4E49\u529F\u80FD\u6269\u5C55\u589E\u5F3A\u80FD\u529B\u3002"),h("p",null,"\u8003\u8651\u5230\u5DE5\u5177\u6027\u8D28\uFF0CBetterNCM \u5C06",h("b",null,"\u6C38\u8FDC\u662F\u5B8C\u5168\u5F00\u6E90\u514D\u8D39\u7684\u81EA\u7531\u8F6F\u4EF6"),"\uFF0C\u6240\u4EE5\u5982\u679C\u4F60\u662F\u4ECE\u4EFB\u4F55\u5730\u65B9\u53D1\u73B0\u6709\u4EFB\u4F55\u4EBA\u5728\u552E\u5356\u672C\u5DE5\u5177\uFF0C\u8BF7\u7ACB\u523B\u8981\u6C42\u9000\u6B3E\u5E76\u4E3E\u62A5\u5546\u5BB6\uFF01 \u4F5C\u4E3A\u4E00\u7FA4\u7231\u597D\u8005\uFF0C\u6211\u4EEC\u4E0D\u4F1A\u4E5F\u6CA1\u529E\u6CD5\u4E3A\u4F60\u56E0\u4E3A\u4ECE\u5176\u5B83\u9014\u5F84\u8D2D\u4E70\u672C\u5DE5\u5177\u9020\u6210\u7684\u635F\u5931\u8D1F\u8D23\uFF01"),h("p",null,"\u5982\u679C\u4F60\u4E5F\u5E0C\u671B\u4E3A BetterNCM \u8D21\u732E\u4EE3\u7801\uFF0C\u6B22\u8FCE\u524D\u6765 BetterNCM \u7684 Github \u5F00\u6E90\u4ED3\u5E93\uFF1A",h("a",{className:"itm",onClick:()=>E.ncm.openUrl("https://github.com/MicroCBer/BetterNCM"),style:{width:"32px",height:"32px"}},"https://github.com/MicroCBer/BetterNCM")),h("p",null,"\u901A\u8FC7\u70B9\u51FB\u53F3\u4E0A\u89D2\u7684\u7F51\u6613\u4E91\u56FE\u6807\uFF08\u5728\u8BBE\u7F6E\u56FE\u6807\u7684\u53F3\u4FA7\uFF09\u53EF\u4EE5\u6253\u5F00\u63D2\u4EF6\u7BA1\u7406\u5668\uFF0C \u7136\u540E\u901A\u8FC7\u63D2\u4EF6\u7BA1\u7406\u5668\u914D\u5957\u7684\u63D2\u4EF6\u5546\u5E97\uFF0C\u5C31\u53EF\u4EE5\u5B89\u88C5\u4F60\u559C\u6B22\u7684\u63D2\u4EF6\u6765\u6269\u5C55\u7F51\u6613\u4E91\u7684\u529F\u80FD\u548C\u5916\u89C2\u54E6\uFF01"),h("button",{onClick:()=>r.onRequestClose()},"\u5F00\u59CB\u4F7F\u7528 BetterNCM"));var q="config.betterncm.manager.openedwarnings";async function G(){let r=document.createElement("section"),l=await E.utils.waitForElement("section.g-mn"),s=await E.utils.waitForElement('a[href="#/m/setting/"]'),o=s.cloneNode(!0);o.href="javascript:void(0)",o.title="BetterNCM",APP_CONF.isOSX?o.innerHTML=`<svg style='transform: scale(0.8);'><use xlink:href="orpheus://orpheus/style/res/svg/sidebar.sp.svg#icn-discover"></use></svg>`:o.innerHTML=`<svg style='transform: scale(0.8);'><use xlink:href="orpheus://orpheus/style/res/svg/topbar.sp.svg#logo_white"></use></svg>`,l.parentElement.insertBefore(r,l.nextElementSibling),s.parentElement.insertBefore(o,s.nextElementSibling),o.style.scale="1.4",o.addEventListener("click",()=>{r.classList.contains("ncmm-show")?g():c()}),ReactDOM.render(h(ne,null),r),r.classList.add("better-ncm-manager"),r.classList.add("g-mn");function c(){r.parentElement!==l.parentElement&&l.parentElement.insertBefore(r,l.nextElementSibling),r.classList.add("ncmm-show"),l.setAttribute("style","display: none !important;")}function g(){r.classList.remove("ncmm-show"),l.removeAttribute("style")}(async()=>(await E.utils.waitForElement("div.cover.u-cover.u-cover-sm > a > span",1e3)).addEventListener("click",g))(),s.addEventListener("click",g),window.addEventListener("hashchange",g),new MutationObserver(v=>{for(let y of v)y.attributeName==="style"&&(r.style.left=l.style.left)}).observe(l,{attributes:!0})}var j=r=>{},ne=()=>{let[r,l]=React.useState(null),s=React.useRef(null),[o,c]=React.useState([]),[g,v]=React.useState(localStorage.getItem(q)!=="true"),y=React.useMemo(_,void 0);return React.useEffect(()=>{function t(a,n){let m=i=>{let x=M[i],d=x.haveConfigElement()?1:0;return x.manifest.name.startsWith("PluginMarket")?Number.MAX_SAFE_INTEGER:d};return m(n)-m(a)}c(Object.keys(M).sort(t)),j=a=>{console.log("\u63D2\u4EF6\u52A0\u8F7D\u5B8C\u6210\uFF01"),c(Object.keys(a).sort(t))}},[]),React.useEffect(()=>{let t=r?.injects.map(a=>a._getConfigElement()).filter(a=>a!==null)||[];if(t.length===0){let a=document.createElement("div");a.innerText="\u8BE5\u63D2\u4EF6\u6CA1\u6709\u53EF\u7528\u7684\u8BBE\u7F6E\u9009\u9879",t.push(a)}s.current?.replaceChildren(...t)},[r]),h("div",{className:"bncm-mgr"},h("div",null,h(K,{onRequestOpenStartupWarnings:()=>{v(!g)}}),y?h(U,null):g?h(z,{onRequestClose:()=>{localStorage.setItem(q,"true"),v(!1)}}):h("section",{style:{display:"flex",flexDirection:"row",flex:"1",marginBottom:"0"}},h("div",{className:"v-scroll loaded-plugins-list",style:{borderRight:"1px solid #8885"}},h("div",null,h("div",null,o.map(t=>{let a=M[t],n=a.haveConfigElement();return h("div",{className:n?r?.manifest.slug===t?"plugin-btn selected":"plugin-btn":"plugin-btn-disabled plugin-btn","data-plugin-slug":t,onClick:()=>{n&&l(a)}},h("span",{className:"plugin-list-name"},a.manifest.name),t!=="PluginMarket"&&h("span",{className:"plugin-uninstall-btn",onClick:async m=>{m.stopPropagation(),await E.fs.remove(a.pluginPath),E.reload()}},h("svg",{xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round",className:"feather feather-trash-2"},h("polyline",{points:"3 6 5 6 21 6"}),h("path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"}),h("line",{x1:10,y1:11,x2:10,y2:17}),h("line",{x1:14,y1:11,x2:14,y2:17}))))})))),h("div",{className:"v-scroll"},h("div",null,h("div",{style:{overflowY:"scroll",overflowX:"hidden",padding:"16px"},ref:s}))))))};var L=class extends EventTarget{pluginPath="";injects=[];manifest;finished=!1;#e=null;devMode=!1;constructor(l,s,o){super(),this.devMode=o,this.manifest=l,this.pluginPath=s,this.addEventListener("load",c=>{this.injects.forEach(g=>{g.dispatchEvent(c)})}),this.addEventListener("allpluginsloaded",c=>{this.injects.forEach(g=>{g.dispatchEvent(c)})})}haveConfigElement(){return this.#e==null&&(this.#e=this.injects.reduce((l,s)=>l??s._getConfigElement(),null)!==null),this.#e}},Y;(o=>{function r(c,g,v=!1,y={}){return dom("a",{class:["u-ibtn5",v&&"u-ibtnsz8"],style:{margin:".2em .5em"},innerText:c,onclick:g,...y})}o.makeBtn=r;function l(c={}){return dom("input",{type:"checkbox",...c})}o.makeCheckbox=l;function s(c,g={}){return dom("input",{value:c,style:{margin:".2em .5em",borderRadius:".5em"},class:["u-txt","sc-flag"],...g})}o.makeInput=s})(Y||={});var B=class extends EventTarget{constructor(s,o){super();this.filePath=o;this.mainPlugin=s,this.manifest=s.manifest,this.pluginPath=s.pluginPath}pluginPath="";manifest;configViewElement=null;mainPlugin;loadError=null;finished=!1;onLoad(s){this.addEventListener("load",o=>{try{s.call(this,o.detail,o)}catch(c){this.loadError=c}})}onConfig(s){this.addEventListener("config",o=>{this.configViewElement=s.call(this,o.detail)})}onAllPluginsLoaded(s){this.addEventListener("allpluginsloaded",function(o){s.call(this,o.detail,o)})}getConfig(s,o){try{let c=JSON.parse(localStorage.getItem(`config.betterncm.${this.manifest.slug}`)||"{}");if(c[s]!==void 0)return c[s]}catch{}return o}setConfig(s,o){let c=JSON.parse(localStorage.getItem(`config.betterncm.${this.manifest.slug}`)||"{}");(!c||typeof c!="object")&&(c=Object.create(null)),c[s]=o,localStorage[`config.betterncm.${this.manifest.slug}`]=JSON.stringify(c)}_getConfigElement(){return this.configViewElement||this.dispatchEvent(new CustomEvent("config",{detail:Y})),this.configViewElement}};var M={},J="betterncm.safemode",Z="betterncm.loaderror",ie="cc.microblock.betterncm.cpp_side_inject_feature_disabled";async function W(){await E.app.writeConfig(ie,"false"),localStorage.removeItem(J),localStorage.removeItem(Z)}var R=class extends Error{constructor(s,o,c,g){super(c,g);this.pluginPath=s;this.rawError=o}toString(){return`\u63D2\u4EF6 ${this.pluginPath} \u52A0\u8F7D\u51FA\u9519: ${this.rawError}`}},O=class extends Error{constructor(l,s){super(l,s)}toString(){return`\u63D2\u4EF6\u4F9D\u8D56\u89E3\u6790\u51FA\u9519: ${this}`}},_=()=>localStorage.getItem(J)==="true",X=()=>localStorage.getItem(Z)||"";function re(r){class l{adjacencyList={};constructor(){}addVertex(a){this.adjacencyList[a]||(this.adjacencyList[a]=[])}addEdge(a,n){this.adjacencyList[a].push(n)}}let s=new l;for(let t of r)s.addVertex(t.manifest.slug);for(let t of r)t.manifest.loadBefore&&t.manifest.loadBefore.forEach(a=>s.addEdge(a,t.manifest.slug)),t.manifest.loadAfter&&t.manifest.loadAfter.forEach(a=>s.addEdge(t.manifest.slug,a));function o(t,a,n,m){if(n[t]=!0,!(t in s.adjacencyList))throw new O(`\u627E\u4E0D\u5230\u63D2\u4EF6 ${t}`);let i=s.adjacencyList[t];for(let x of i)n[x]||(a=o(x,a,n,m));return m[t]=a,a-1}let c=Object.keys(s.adjacencyList),g={},v={},y=c.length-1;for(let t of c)g[t]||(y=o(t,y,g,v));return Object.keys(v).map(t=>r.find(a=>a.manifest.slug===t))}async function se(){if(_()){window.loadedPlugins=M;return}let r=E.utils.debounce(E.reload,1e3),l=async function(){}.constructor,o={"/pub/app.html":"Main"}[location.pathname];async function c(n){console.log("\u6B63\u5728\u52A0\u8F7D\u63D2\u4EF6",n.manifest.name);let m=n.devMode,i=n.manifest,x=n.pluginPath;if(m&&!i.noDevReload)try{betterncm_native.fs.watchDirectory(x,(e,u)=>{[".js","manifest.json"].findIndex(w=>u.endsWith(w))!==-1&&(console.warn("\u5F00\u53D1\u63D2\u4EF6",i.name,"\u6587\u4EF6",u,"\u53D1\u751F\u66F4\u65B0\uFF0C\u5373\u5C06\u91CD\u8F7D\uFF01"),r())})}catch{}async function d(e){if(!i.slug)return;let u=await E.fs.readFileText(e);if(e.endsWith(".js")){let p=new B(n,e);try{await new l("plugin",u).call(M[i.slug],p)}catch(w){throw new R(e,w,`\u63D2\u4EF6\u811A\u672C ${e} \u89E3\u6790\u51FA\u9519: ${w.stack||w}`,{cause:w})}if(p.dispatchEvent(new CustomEvent("load",{detail:p})),p.loadError)throw new R(e,p.loadError,`\u63D2\u4EF6\u811A\u672C ${e} \u52A0\u8F7D\u51FA\u9519: ${p.loadError.stack||p.loadError}`,{cause:p.loadError});p.finished=!0,M[i.slug].injects.push(p)}}if(i.injects[o])for(let e of i.injects[o])await d(`${x}/${e.file}`);if(i.injects[location.pathname])for(let e of i.injects[location.pathname])await d(`${x}/${e.file}`);n.finished=!0}window.loadedPlugins=M;let g=(await E.fs.readDir("./plugins_runtime")).filter(n=>!n.substring(n.lastIndexOf("/")).startsWith("/.")),v=[],y=async(n,m)=>{if(await E.fs.exists(`${n}/manifest.json`))try{let i=JSON.parse(await E.fs.readFileText(`${n}/manifest.json`));i.slug??=i.name.replace(/[^a-zA-Z0-9 ]/g,"").replace(/ /g,"-");let x=new L(i,n,m);v.push(x)}catch(i){if(i instanceof SyntaxError)console.error("\u63D2\u4EF6\u52A0\u8F7D\u5931\u8D25\uFF1A",i);else throw console.warn("\u89E3\u6790\u63D2\u4EF6\u5143\u6570\u636E\u5931\u8D25\uFF1A",n,i),i}};v=re(v);let t=[];for(let n of g)t.push(y(n,!1));if(await E.fs.exists("./plugins_dev")){let n=await E.fs.readDir("./plugins_dev");for(let m of n)t.push(y(m,!0))}await Promise.all(t);let a=v.map(n=>n.manifest.slug in M?(console.warn(n.manifest.slug,"duplicated, the plugin at",n.pluginPath,"wont be loaded."),Promise.resolve()):(M[n.manifest.slug]=n,c(n)));try{await Promise.all(a)}catch(n){console.warn("\u63D2\u4EF6\u52A0\u8F7D\u51FA\u9519\uFF01",n,n.name,n.stack)}for(let n in M)M[n].injects.forEach(i=>{if(i.dispatchEvent(new CustomEvent("allpluginsloaded",{detail:M})),i.loadError)throw new R(i.filePath,i.loadError,`\u63D2\u4EF6\u811A\u672C ${i.filePath} \u52A0\u8F7D\u51FA\u9519: ${i.loadError.stack||i.loadError}`,{cause:i.loadError})})}window.addEventListener("DOMContentLoaded",async()=>{try{let r=await(await b("/internal/framework.css")).text(),l=document.createElement("style");l.innerHTML=r,document.head.appendChild(l),await G();try{await se()}catch(s){console.warn(s,s.stack)}"loadingMask"in window&&loadingMask.animate([{opacity:1},{opacity:0,display:"none"}],{duration:300,fill:"forwards",easing:"cubic-bezier(0.42,0,0.58,1)"}).commitStyles(),j(M)}catch(r){document.body.innerHTML=r}});})();
//# sourceMappingURL=framework.js.map
